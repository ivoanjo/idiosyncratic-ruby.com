<!doctype html>
<html>
  <head>
    <title>Idiosyncratic Ruby: Identification</title>
    <link rel="alternate" type="application/atom+xml" title="Idiosyncratic Ruby Feed" href="/feed.xml" />
<link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />

<script src="/javascripts/jquery.min.js" type="text/javascript"></script><script src="/javascripts/app.js" type="text/javascript"></script>

<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<meta name="description" content="Documenting All Ruby Specialities."/>
<meta name="keywords" content="ruby, core, hash"/>

  </head>

  <body>
    <div class="world">
      <section class="post-header">
        <a href="/" class="post-logo"><img src="/images/idiosyncratic.png" alt="Idiosyncratic Ruby"></a>
        <h1 class="post-heading" id="top"><a href="/35-identification.html">Identification</a></h1>
      </section>

      <article class="post">
        <p>Is it a hash? Or is it a hash?</p>

<p></p>

<pre><code>hash = {"Idiosyncratic" =&gt; "Ruby"}
hash["Idiosyncratic"] # =&gt; "Ruby"

hash.compare_by_identity
idiosyncratic_in_variable = "Idiosyncratic"
hash[idiosyncratic_in_variable] # =&gt; nil
hash["Idiosyncratic"] # =&gt; "Ruby"
</code></pre>

<p><a href="https://ruby-doc.org/core/Hash.html#method-i-compare_by_identity"><code>Hash#compare_by_identity</code></a> changes the semantics of what is equal in a hash and what not. Only if exact the same object is passed in, the value will be retrieved.</p>

<p><strong>Please note:</strong> The above example works for the key of<code>"Idiosyncratic"</code>, because every string literal returns the same object. This behaviour has been introduced with Ruby 2.2, so running it in 2.1 or lower will return <code>nil</code> for the last line.</p>

<h2 id="hash-surprise">Hash Surprise</h2>

<p>Identity hashes can feel very unnatural as the following snippet illustrates:</p>

<pre><code>hash = {}.compare_by_identity

a="Idiosyncratic"
b="Idiosyncratic"
c="Idiosyncratic"

hash[a] = "Ruby1"
hash[b] = "Ruby2"
hash[c] = "Ruby3"

hash #=&gt; {"Idiosyncratic"=&gt;"Ruby1",
     #    "Idiosyncratic"=&gt;"Ruby2",
     #    "Idiosyncratic"=&gt;"Ruby3"}

# Quiz: What is the result of: hash["Idiosyncratic"]
</code></pre>

<h2 id="explicit-identity-hashes">Explicit Identity Hashes</h2>

<p>What can be done to improve readability and reduce surprise? A starting point can be using an extra class:</p>

<pre><code>class IdentityHash &lt; Hash
  def initialize(*)
    super.compare_by_identity
  end

  def inspect
    "#&lt;IdentityHash: #{super}&gt;"
  end
end
</code></pre>

<p>For this class to be really useful it would need some more Hash-like features, like ActiveSupport does with <a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/hash_with_indifferent_access.rb">HashWithIndifferentAccess</a>. Still, it is already less confusable than some hash that looks like a normal hash and that you haven't checked <code>compare_by_identity?</code> for.</p>


        <h2>More Idiosyncratic Ruby</h2>
        <ul>
          <li><a href="https://github.com/janlelis/idiosyncratic-ruby.com/commit/c46b41ba73f30ea9194b4398332ee6be04dfe543#all_commit_comments">Please Comment on GitHub</a></li>
            <li>Next Article: <a href="/36-erb-render-standard.html">ERB Render Standard</a></li>
            <li>Previous Article: <a href="/34-utility-gems.html">Utility Gems</a></li>
        </ul>
      </article>

      <footer>
        <div class="footer-right">
          On <a href="/">Idiosyncratic Ruby</a> by <a href="https://janlelis.com">Jan Lelis</a><br>
          
          <a href="https://janlelis.com/data-protection.html">Data Protection</a>
        </div>
        About Core, Hash<br>
        Last Update: December 25, 2017
      </footer>
    </div>
    <script src="/javascripts/rainbow-custom.min.js" type="text/javascript"></script>
  </body>
</html>